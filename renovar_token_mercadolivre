import json

async def renovar_token_mercadolivre():
    """Renova o token de acesso do Mercado Livre automaticamente e salva no .env."""
    global ML_ACCESS_TOKEN, ML_REFRESH_TOKEN
    url = "https://api.mercadolibre.com/oauth/token"
    payload = {
        "grant_type": "refresh_token",
        "client_id": ML_CLIENT_ID,
        "client_secret": ML_CLIENT_SECRET,
        "refresh_token": ML_REFRESH_TOKEN,
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=payload) as resp:
            data = await resp.json()
            if resp.status != 200:
                logger.error(Fore.RED + f"Erro ao renovar token ML: {data}")
                return

            ML_ACCESS_TOKEN = data.get("access_token")
            ML_REFRESH_TOKEN = data.get("refresh_token")

            # Atualiza variÃ¡veis no ambiente atual
            os.environ["ML_ACCESS_TOKEN"] = ML_ACCESS_TOKEN
            os.environ["ML_REFRESH_TOKEN"] = ML_REFRESH_TOKEN

            # Salva em um arquivo local .env (Railway recria a cada deploy, mas persiste no volume se configurado)
            try:
                with open(".env", "r", encoding="utf-8") as f:
                    env_lines = f.readlines()
            except FileNotFoundError:
                env_lines = []

            new_lines = []
            keys_to_update = {"ML_ACCESS_TOKEN": ML_ACCESS_TOKEN, "ML_REFRESH_TOKEN": ML_REFRESH_TOKEN}
            for line in env_lines:
                key = line.split("=")[0].strip()
                if key in keys_to_update:
                    new_lines.append(f"{key}={keys_to_update[key]}\n")
                    keys_to_update.pop(key)
                else:
                    new_lines.append(line)

            for k, v in keys_to_update.items():
                new_lines.append(f"{k}={v}\n")

            with open(".env", "w", encoding="utf-8") as f:
                f.writelines(new_lines)

            logger.info(Fore.GREEN + "ðŸ”‘ Token Mercado Livre renovado e salvo no .env!")
